<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WebAR MindAR — pistas.glb (diagnóstico de animação)</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <!-- animation-mixer -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.4.0/dist/aframe-extras.min.js"></script>

  <style>
    html, body { margin:0; padding:0; background:transparent; overflow:hidden; }
    .a-canvas, canvas { background:transparent !important; display:block; }
    body, a-scene { width:100vw; height:100vh; }
  </style>
</head>
<body>

  <a-scene
    mindar-image="imageTargetSrc: ./target.mind; maxTrack: 1"
    renderer="alpha:true; antialias:false; physicallyCorrectLights:false; powerPreference:high-performance"
    embedded
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false"
    style="width:100vw; height:100vh;">

    <a-assets timeout="30000">
      <a-asset-item id="pistas" src="./pistas.glb"></a-asset-item>
    </a-assets>

    <a-camera look-controls="enabled:false"></a-camera>

    <a-entity id="anchor" mindar-image-target="targetIndex: 0">
      <a-entity id="model"
        gltf-model="#pistas"
        position="0 0 0.02"
        rotation="0 0 0"
        scale="0.4 0.4 0.4"
        animation-mixer="clip:*; loop:repeat; repetitions:Infinity">
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    // ---- Diagnóstico: loga clips encontrados e garante play mesmo sem animation-mixer ----
    const modelEl = document.getElementById('model');
    const anchorEl = document.getElementById('anchor');

    let mixer = null;
    let action = null;
    let clip = null;

    // Loga os clips quando o modelo carregar
    modelEl.addEventListener('model-loaded', (e) => {
      const model = e.detail.model;
      const anims = (model && model.animations) || [];
      console.log('[DEBUG] modelo carregado. Animations count =', anims.length);
      anims.forEach((c, idx) => console.log(`[DEBUG] clip[${idx}] name="${c.name}" duration=${c.duration.toFixed(3)}s`));

      if (!anims.length) {
        console.warn('[DEBUG] Nenhuma animação embutida em pistas.glb. O modelo pode ser estático.');
        return;
      }

      // Tenta usar animation-mixer do A-Frame
      const am = modelEl.components['animation-mixer'];
      if (am && am.mixer) {
        console.log('[DEBUG] animation-mixer detectado. Vai tocar o(s) clip(s).');
        // Nada a fazer: animation-mixer já está configurado com clip:* loop:repeat
        // Ainda assim guardamos mixer/clip para controle extra se precisar
        mixer = am.mixer;
        // Pega a primeira action viva (se existir)
        const acts = am.mixer._actions || [];
        if (acts.length) action = acts[0];
      } else {
        // Fallback manual
        console.log('[DEBUG] animation-mixer não criou mixer. Iniciando fallback manual.');
        mixer = new THREE.AnimationMixer(model);
        clip = anims[0];
        action = mixer.clipAction(clip);
        action.loop = THREE.LoopRepeat;
        action.clampWhenFinished = false;
        action.enabled = true;
        action.play();

        // Atualiza o mixer todo frame
        modelEl.sceneEl.addEventListener('renderstart', () => {
          modelEl.sceneEl.addEventListener('tick', (evt) => {
            if (!mixer) return;
            // evt.detail.delta no A-Frame 1.6.0 é ms
            const delta = (evt.detail && evt.detail.delta) ? evt.detail.delta / 1000 : 0.016;
            mixer.update(delta);
          });
        }, { once:true });
      }
    });

    // Só dispara o play quando o target for encontrado (garante visão AR estável)
    anchorEl.addEventListener('targetFound', () => {
      console.log('[DEBUG] targetFound');
      // Em animation-mixer, o play é automático; ainda assim, tentamos garantir:
      try {
        const am = modelEl.components['animation-mixer'];
        if (am && am.mixer && am.mixer._actions && am.mixer._actions.length) {
          am.mixer._actions.forEach(a => { a.paused = false; a.enabled = true; a.play(); });
        } else if (action) {
          action.paused = false; action.enabled = true; action.play();
        }
      } catch(e) { console.warn('[DEBUG] erro ao forçar play:', e); }
    });

    // Quando perder o target, pausa todas as actions (para evitar gasto desnecessário)
    anchorEl.addEventListener('targetLost', () => {
      console.log('[DEBUG] targetLost');
      try {
        const am = modelEl.components['animation-mixer'];
        if (am && am.mixer && am.mixer._actions && am.mixer._actions.length) {
          am.mixer._actions.forEach(a => { a.paused = true; });
        } else if (action) {
          action.paused = true;
        }
      } catch(e) { console.warn('[DEBUG] erro ao pausar:', e); }
    });
  </script>
</body>
</html>

